<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿå­˜æŒ‡å—ï¼šæ°‘é˜²æ‡‰è®Šæ¨¡æ“¬</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --accent-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --card-bg: #2d2d2d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }

        h1, h2 {
            color: var(--accent-color);
            text-align: center;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            background: #333;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .status-item span {
            font-weight: bold;
        }

        .scene-image {
            width: 100%;
            height: 150px;
            background-color: #444;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            border-radius: 8px;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }

        .description {
            font-size: 1.1rem;
            margin-bottom: 25px;
            min-height: 80px;
        }

        .options-grid {
            display: grid;
            gap: 10px;
        }

        button {
            background-color: #444;
            color: white;
            border: 1px solid #555;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            text-align: left;
        }

        button:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        button.danger:hover {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .inventory-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .inv-item {
            background: #3a3a3a;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .inv-item input {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .feedback-box {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid var(--warning-color);
            display: none;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #444;
            height: 6px;
            border-radius: 3px;
            margin-top: 20px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container" id="game-container"></div>

<script>
// ============================================================================
// CONFIGURATION & DATA
// ============================================================================

const CONFIG = {
    RANK_THRESHOLDS: { S: 250, A: 200, B: 150, C: 0 },
    CRITICAL_HP: 50,
    CRITICAL_SANITY: 50,
    SCORES: {
        CORRECT_ITEM: 10,
        MISSING_ITEM: -5,
        WRONG_ITEM: -10
    }
};

const INVENTORY_ITEMS = [
    { id: 'water', name: 'é£²ç”¨æ°´ (3å…¬å‡)', correct: true, weight: 3 },
    { id: 'food', name: 'ç½é ­/èƒ½é‡æ£’', correct: true, weight: 1 },
    { id: 'radio', name: 'æ‰‹æ–å¼æ”¶éŸ³æ©Ÿ', correct: true, weight: 1 },
    { id: 'ps5', name: 'éŠæˆ²ä¸»æ©Ÿ', correct: false, weight: 3 },
    { id: 'firstaid', name: 'æ€¥æ•‘ç®± & è—¥å“', correct: true, weight: 1 },
    { id: 'beer', name: 'ä¸€æ‰“å•¤é…’', correct: false, weight: 4 },
    { id: 'id_card', name: 'èº«åˆ†è­‰ä»¶å½±æœ¬ & ç¾é‡‘', correct: true, weight: 0 },
    { id: 'whistle', name: 'å“¨å­ & æ‰‹é›»ç­’', correct: true, weight: 0.5 },
    { id: 'warm_clothes', name: 'ä¿æš–è¡£ç‰©/è¼•ä¾¿é›¨è¡£', correct: true, weight: 1 },
    { id: 'gold', name: 'æ²‰é‡çš„é‡‘æ¢', correct: false, weight: 5 }
];

const DISASTER_SCENARIOS = {
    earthquake: {
        name: 'åœ°éœ‡',
        startScene: 'earthquake_start',
        scenes: {
            earthquake_start: {
                title: "è­¦å ±ï¼šå¼·çƒˆåœ°éœ‡",
                emoji: "ğŸ“‰",
                text: "æ‰‹æ©Ÿç™¼å‡ºå·¨å¤§çš„åœ‹å®¶ç´šè­¦å ±è²éŸ¿ï¼å¹¾ç§’å¾Œï¼Œåœ°é¢é–‹å§‹åŠ‡çƒˆæ–æ™ƒï¼Œæ›¸æ¶ä¸Šçš„æ›¸ç´›ç´›æ‰è½ã€‚ä½ ç¾åœ¨ä½æ–¼å®¢å»³ã€‚",
                options: [
                    { 
                        text: "ç«‹åˆ»è¡å‡ºå¤§é–€é€ƒåˆ°æˆ¶å¤–ï¼", 
                        next: "eq_run", 
                        impact: { hp: -30, sanity: -10 }, 
                        feedback: "éŒ¯èª¤ï¼åœ°éœ‡ç•¶ä¸‹ç§»å‹•éå¸¸å±éšªï¼Œå®¹æ˜“è·Œå€’æˆ–è¢«æ‰è½ç‰©ç ¸å‚·ã€‚" 
                    },
                    { 
                        text: "èº²åœ¨å …å›ºæ¡Œå­ä¸‹ï¼ŒæŠ“ç©©æ¡Œè…³ (DCH)", 
                        next: "eq_hide", 
                        impact: { hp: 0, sanity: 5 }, 
                        feedback: "æ­£ç¢ºï¼è¶´ä¸‹(Drop)ã€æ©è­·(Cover)ã€ç©©ä½(Hold on)æ˜¯åœ°éœ‡ä¿å‘½ä¸‰æ­¥é©Ÿã€‚" 
                    },
                    { 
                        text: "å»æ‰“é–‹å¤§é–€ï¼Œé¿å…è®Šå½¢å—å›°", 
                        next: "eq_open_door", 
                        impact: { hp: -10, sanity: 0 }, 
                        feedback: "å±éšªï¼åªæœ‰åœ¨æ™ƒå‹•æ¥µå°æˆ–åœæ­¢æ™‚æ‰å»é–‹é–€ï¼Œæ™ƒå‹•ä¸­ç§»å‹•å®¹æ˜“å—å‚·ã€‚" 
                    }
                ]
            },
            eq_run: {
                title: "æˆ¶å¤–æ›´å±éšª",
                emoji: "ğŸ¤•",
                text: "ä½ è·Œè·Œæ’æ’è¡å‡ºé–€ï¼Œçµæœè¢«å…¬å¯“å¤–ç‰†å‰è½çš„ç£ç£šç ¸ä¸­è‚©è†€ã€‚æ™ƒå‹•åœæ­¢äº†ã€‚",
                options: [{ text: "æª¢æŸ¥å‚·å‹¢ä¸¦é¿é›£", next: "end_scene" }]
            },
            eq_hide: {
                title: "æ™ƒå‹•åœæ­¢",
                emoji: "ğŸ˜°",
                text: "æ–æ™ƒéå¸¸åŠ‡çƒˆï¼Œä½†æ¡Œå­ä¿è­·äº†ä½ å…å—æ‰è½ç‡ˆå…·çš„å‚·å®³ã€‚åœ°éœ‡ç¨åœäº†ã€‚",
                options: [
                    { 
                        text: "ç«‹åˆ»é—œé–‰ç«æºèˆ‡ç“¦æ–¯ï¼Œç©¿ä¸Šé‹å­", 
                        next: "end_scene", 
                        impact: { score: 10 }, 
                        feedback: "éå¸¸å°ˆæ¥­ï¼é˜²æ­¢æ¬¡ç”Ÿç½å®³ï¼ˆç«ç½ï¼‰ä¸¦ä¿è­·è…³éƒ¨ã€‚" 
                    },
                    { 
                        text: "é¦¬ä¸Šæ‰“é›»è©±çµ¦è¦ªå‹å ±å¹³å®‰", 
                        next: "end_scene", 
                        impact: { score: -5 }, 
                        feedback: "å»ºè­°å‚³ç°¡è¨Šæˆ–ä½¿ç”¨ç¶²è·¯ï¼Œé¿å…ä½”ç”¨ç·Šæ€¥æ•‘ç½ç·šè·¯ã€‚" 
                    }
                ]
            },
            eq_open_door: {
                title: "æ–æ™ƒä¸­è·Œå€’",
                emoji: "ğŸ’«",
                text: "ä½ è©¦åœ–èµ°å‘é–€å£ï¼Œä½†åŠ‡çƒˆçš„æ–æ™ƒè®“ä½ ç«™ä¸ç©©æ’åˆ°ç‰†å£ã€‚å¥½ä¸å®¹æ˜“æŠŠé–€æ‰“é–‹äº†ä¸€æ¢ç¸«ã€‚",
                options: [{ text: "ç¹¼çºŒä¸‹ä¸€æ­¥", next: "end_scene" }]
            }
        }
    },
    typhoon: {
        name: 'é¢±é¢¨',
        startScene: 'typhoon_start',
        scenes: {
            typhoon_start: {
                title: "è­¦å ±ï¼šå¼·çƒˆé¢±é¢¨",
                emoji: "ğŸŒ€",
                text: "è¶…ç´šé¢±é¢¨ç™»é™¸ï¼Œçª—å¤–é¢¨é›¨äº¤åŠ ï¼Œé›»åŠ›çªç„¶ä¸­æ–·äº†ï¼Œå®¤å…§ä¸€ç‰‡æ¼†é»‘ã€‚æ°´å£“ä¹Ÿé–‹å§‹ä¸‹é™ã€‚",
                options: [
                    { 
                        text: "é»ç‡ƒè Ÿç‡­ç…§æ˜", 
                        next: "ty_candle", 
                        impact: { hp: -50, sanity: -20 }, 
                        feedback: "æ¥µåº¦å±éšªï¼é¢±é¢¨å¤©é–€çª—ç·Šé–‰ï¼Œé»è Ÿç‡­å®¹æ˜“å¼•ç™¼ç«ç½ä¸”æ¶ˆè€—æ°§æ°£ã€‚" 
                    },
                    { 
                        text: "æ‹¿å‡ºé¿é›£åŒ…ä¸­çš„æ‰‹é›»ç­’èˆ‡æ”¶éŸ³æ©Ÿ", 
                        next: "ty_safe", 
                        impact: { sanity: 10 }, 
                        feedback: "æ­£ç¢ºï¼ä½¿ç”¨é›»æ± ä¾›é›»è¨­å‚™æœ€å®‰å…¨ï¼Œä¸¦é€éæ”¶éŸ³æ©ŸæŒæ¡ç½æƒ…ã€‚" 
                    },
                    { 
                        text: "è¶é¢¨é›¨é‚„æ²’æœ€å¤§ï¼Œå‡ºå»è²·æ³¡éºµ", 
                        next: "ty_out", 
                        impact: { hp: -80 }, 
                        feedback: "åƒè¬ä¸è¦ï¼æ‰è½çš„æ‹›ç‰Œèˆ‡æ¨¹æœ¨å¯èƒ½è‡´å‘½ã€‚" 
                    }
                ]
            },
            ty_candle: {
                title: "æ„å¤–èµ·ç«",
                emoji: "ğŸ”¥",
                text: "å¼·é¢¨å¹å€’äº†è Ÿç‡­ï¼Œçª—ç°¾è‘—ç«äº†ï¼ä½ æ‰‹å¿™è…³äº‚åœ°æ»…ç«ã€‚",
                options: [{ text: "å¥½ä¸å®¹æ˜“æ»…ç«ï¼Œç­‰å¾…é¢¨é›¨éå»", next: "end_scene" }]
            },
            ty_safe: {
                title: "å®‰ç„¶åº¦é",
                emoji: "ğŸ“»",
                text: "ä½ åƒè‘—å­˜ç³§ï¼Œè½è‘—æ”¶éŸ³æ©Ÿè£¡çš„å»£æ’­ï¼Œé›–ç„¶å¤–é¢é¢¨é›¨å¾ˆå¤§ï¼Œä½†ä½ æ„Ÿåˆ°ç›¸å°å®‰å¿ƒã€‚",
                options: [{ text: "ç­‰å¾…é¢¨é›¨éå»", next: "end_scene" }]
            },
            ty_out: {
                title: "é¢¨é›¨ç„¡æƒ…",
                emoji: "ğŸš‘",
                text: "ä½ å‰›å‡ºé–€å°±è¢«å¼·é¢¨å¹å€’ï¼Œé‚„å·®é»è¢«çœ‹æ¿ç ¸ä¸­ï¼Œåªèƒ½ç‹¼ç‹½åœ°çˆ¬å›å®¶ã€‚",
                options: [{ text: "è™•ç†å‚·å£", next: "end_scene" }]
            }
        }
    },
    war: {
        name: 'ç©ºè¥²',
        startScene: 'war_start',
        scenes: {
            war_start: {
                title: "è­¦å ±ï¼šé˜²ç©ºè­¦å ±",
                emoji: "ğŸ“¢",
                text: "ã€Œå—šâ€”â€”ã€é•·éŸ³15ç§’ã€çŸ­éŸ³5ç§’çš„è­¦å ±è²éŸ¿å¾¹é›²éœ„ã€‚æ‰‹æ©Ÿæ”¶åˆ°ã€Œé£›å½ˆç©ºè¥²è­¦å ±ã€ã€‚ä½ ä½åœ¨å¤§æ¨“çš„äº”æ¨“ã€‚",
                options: [
                    { 
                        text: "è·‘åˆ°é ‚æ¨“çœ‹æ˜¯ä¸æ˜¯çœŸçš„æœ‰é£›å½ˆ", 
                        next: "war_roof", 
                        impact: { hp: -100 }, 
                        feedback: "è‡ªæ®ºè¡Œç‚ºï¼é€™ä¸æ˜¯çœ‹ç…™ç«ã€‚" 
                    },
                    { 
                        text: "ç«‹åˆ»æ­é›»æ¢¯ä¸‹æ¨“å»åœ°ä¸‹å®¤", 
                        next: "war_elevator", 
                        impact: { hp: -50 }, 
                        feedback: "å±éšªï¼ç©ºè¥²å¯èƒ½å°è‡´åœé›»ï¼Œä½ æœƒè¢«å›°åœ¨é›»æ¢¯è£¡ã€‚" 
                    },
                    { 
                        text: "æ¡ã€Œé¿é›£å§¿å‹¢ã€èº²åœ¨ç„¡çª—çš„æˆ¿é–“æˆ–å …å›ºç‰†è§’", 
                        next: "war_hide", 
                        impact: { score: 20 }, 
                        feedback: "æ­£ç¢ºï¼é é›¢çª—æˆ¶ï¼ˆé¿å…ç»ç’ƒéœ‡ç¢ï¼‰ï¼Œæ¡è·ªå§¿ã€æ©è€³ã€å¾®å¼µå˜´ï¼ˆé˜²çˆ†éœ‡ï¼‰ã€‚" 
                    }
                ]
            },
            war_roof: {
                title: "è‡´å‘½çš„å¥½å¥‡å¿ƒ",
                emoji: "ğŸ’€",
                text: "é è™•çš„çˆ†ç‚¸è¡æ“Šæ³¢éœ‡ç¢äº†æ‰€æœ‰ç»ç’ƒï¼Œä½ å—äº†é‡å‚·ã€‚",
                options: [{ text: "å‹‰å¼·ç”Ÿå­˜...", next: "end_scene" }]
            },
            war_elevator: {
                title: "å—å›°",
                emoji: "ğŸš«",
                text: "é›»åŠ›ä¸­æ–·ï¼Œä½ è¢«å¡åœ¨é›»æ¢¯è£¡ï¼Œææ‡¼æ„Ÿè¥²ä¾†ã€‚å¤–é¢å‚³ä¾†çˆ†ç‚¸è²ã€‚",
                options: [{ text: "ç­‰å¾…æ•‘æ´...", next: "end_scene" }]
            },
            war_hide: {
                title: "æ¼«é•·çš„ç­‰å¾…",
                emoji: "ğŸ§˜",
                text: "ä½ è½è‘—å¤–é¢çš„å·¨éŸ¿ï¼Œèº«é«”å› æ¡é¿é›£å§¿å‹¢è€Œç— ç—›ï¼Œä½†ä½ æ²’æœ‰å—å‚·ã€‚ä½ çš„é¿é›£åŒ…å°±åœ¨æ‰‹é‚Šã€‚",
                options: [{ text: "è­¦å ±è§£é™¤å¾Œ...", next: "end_scene" }]
            }
        }
    }
};

// ============================================================================
// GAME STATE MANAGEMENT
// ============================================================================

class GameState {
    constructor() {
        this.reset();
    }

    reset() {
        this.hp = 100;
        this.sanity = 100;
        this.supplies = [];
        this.score = 0;
        this.currentScene = 'intro';
        this.currentDisaster = null;
        this.history = [];
        this.lastFeedback = null;
        this.missingItems = [];
    }

    applyImpact(impact) {
        if (!impact) return;
        
        if (impact.hp) this.hp = Math.max(0, Math.min(100, this.hp + impact.hp));
        if (impact.sanity) this.sanity = Math.max(0, Math.min(100, this.sanity + impact.sanity));
        if (impact.score) this.score += impact.score;
    }

    addHistory(scene, action, feedback) {
        this.history.push({ scene, action, feedback });
    }

    isDead() {
        return this.hp <= 0;
    }

    calculateFinalScore() {
        return this.score + this.hp + this.sanity;
    }

    getRank() {
        const finalScore = this.calculateFinalScore();
        for (const [rank, threshold] of Object.entries(CONFIG.RANK_THRESHOLDS)) {
            if (finalScore >= threshold) return rank;
        }
        return 'C';
    }
}

// ============================================================================
// INVENTORY MANAGEMENT
// ============================================================================

class InventoryManager {
    static evaluateSelection(selectedIds) {
        let score = 0;
        const missingItems = [];

        INVENTORY_ITEMS.forEach(item => {
            const isSelected = selectedIds.includes(item.id);
            
            if (item.correct && isSelected) {
                score += CONFIG.SCORES.CORRECT_ITEM;
            } else if (item.correct && !isSelected) {
                score += CONFIG.SCORES.MISSING_ITEM;
                missingItems.push(item.name);
            } else if (!item.correct && isSelected) {
                score += CONFIG.SCORES.WRONG_ITEM;
            }
        });

        return { score, missingItems };
    }

    static hasWrongItems(supplies) {
        const wrongItems = ['ps5', 'beer', 'gold'];
        return wrongItems.some(item => supplies.includes(item));
    }
}

// ============================================================================
// SCENE MANAGEMENT
// ============================================================================

class SceneManager {
    constructor(gameState) {
        this.gameState = gameState;
        this.baseScenes = {
            intro: {
                title: "åºç« ï¼šå¹³éœçš„æ—¥å¸¸",
                emoji: "ğŸ ",
                text: "ç¾åœ¨æ˜¯ 2025 å¹´çš„æŸå€‹é€±æœ«ã€‚æ–°èå ±å°åœ‹éš›å±€å‹¢é€æ¼¸ç·Šå¼µï¼Œæ°£è±¡å±€ä¹Ÿç™¼å¸ƒäº†é¢±é¢¨è­¦å ±ï¼Œä¸”åœ°éœ‡é »å‚³ã€‚æ”¿åºœå‘¼ç±²æ°‘çœ¾æº–å‚™ã€Œç·Šæ€¥é¿é›£åŒ…ã€ã€‚ä½ å®¶è£¡æœ‰ä¸€äº›ç‰©è³‡ï¼Œä½ æ±ºå®šç¾åœ¨å°±æ•´ç†èƒŒåŒ…ã€‚",
                type: "inventory"
            },
            check_inventory: {
                title: "æ•´å‚™ç¢ºèª",
                emoji: "ğŸ’",
                text: "ä½ æ‰“åŒ…å¥½äº†ã€‚å¦‚æœçœŸçš„ç™¼ç”Ÿç·Šæ€¥ç‹€æ³ï¼Œé€™äº›æ±è¥¿å°‡æ±ºå®šä½ çš„å‘½é‹ã€‚",
                options: [
                    { text: "æº–å‚™å¥½äº†ï¼Œé–‹å§‹æ¨¡æ“¬ç”Ÿæ´»", next: "random_event" }
                ]
            },
            random_event: {
                title: "çªç™¼ç‹€æ³",
                emoji: "ğŸ²",
                text: "æ—¥å­éäº†ä¸€æ®µæ™‚é–“ï¼Œçªç„¶...",
                type: "random"
            },
            end_scene: {
                title: "æ¨¡æ“¬çµæŸ",
                emoji: "ğŸ",
                text: "å±æ©Ÿæš«æ™‚è§£é™¤äº†ã€‚ç¾åœ¨ä¾†æª¢è¦–ä½ çš„ç”Ÿå­˜ç‹€æ³ã€‚",
                type: "summary"
            }
        };
    }

    getScene(sceneId) {
        // Check base scenes first
        if (this.baseScenes[sceneId]) {
            return this.baseScenes[sceneId];
        }

        // Check disaster-specific scenes
        if (this.gameState.currentDisaster) {
            const disaster = DISASTER_SCENARIOS[this.gameState.currentDisaster];
            if (disaster && disaster.scenes[sceneId]) {
                return disaster.scenes[sceneId];
            }
        }

        console.error(`Scene not found: ${sceneId}`);
        return null;
    }

    selectRandomDisaster() {
        const disasters = Object.keys(DISASTER_SCENARIOS);
        const randomDisaster = disasters[Math.floor(Math.random() * disasters.length)];
        this.gameState.currentDisaster = randomDisaster;
        return DISASTER_SCENARIOS[randomDisaster].startScene;
    }
}

// ============================================================================
// RENDERING
// ============================================================================

class Renderer {
    constructor(container, gameState) {
        this.container = container;
        this.gameState = gameState;
    }

    renderStatusBar() {
        const hpColor = this.gameState.hp < CONFIG.CRITICAL_HP ? '#ff4444' : '#4caf50';
        const sanityColor = this.gameState.sanity < CONFIG.CRITICAL_SANITY ? '#ff9800' : '#2196f3';
        
        return `
            <div class="status-bar">
                <div class="status-item">â¤ï¸ ç”Ÿå‘½: <span style="color:${hpColor}">${this.gameState.hp}</span></div>
                <div class="status-item">ğŸ§  å¿ƒæ™º: <span style="color:${sanityColor}">${this.gameState.sanity}</span></div>
            </div>
        `;
    }

    renderInventorySelection() {
        let html = `
            <div class="status-bar">è«‹é¸æ“‡è¦æ”¾å…¥ã€Œç·Šæ€¥é¿é›£åŒ…ã€çš„ç‰©å“ (å»ºè­°é‡é‡æœ‰é™ï¼Œè«‹æ˜æ™ºé¸æ“‡)</div>
            <div class="scene-image">ğŸ’</div>
            <div class="description">ä½ çš„èƒŒåŒ…ç©ºé–“æœ‰é™ã€‚è«‹å‹¾é¸ä½ èªç‚ºåœ¨ç½é›£ä¸­æœ€éœ€è¦çš„ç‰©å“ï¼š</div>
            <div class="inventory-list">
        `;
        
        INVENTORY_ITEMS.forEach(item => {
            html += `
                <label class="inv-item">
                    <input type="checkbox" value="${item.id}" id="check-${item.id}">
                    ${item.name}
                </label>
            `;
        });

        html += `
            </div>
            <button onclick="game.confirmInventory()" style="width:100%; text-align:center; background:var(--accent-color)">ç¢ºèªæ‰“åŒ…</button>
        `;
        
        this.container.innerHTML = html;
    }

    renderScene(scene) {
        let html = this.renderStatusBar();
        html += `<div class="scene-image">${scene.emoji}</div>`;
        html += `<h2>${scene.title}</h2>`;
        html += `<div class="description">${scene.text}</div>`;
        
        if (scene.options) {
            html += `<div class="options-grid">`;
            scene.options.forEach((opt, index) => {
                html += `<button onclick="game.makeChoice(${index})">${opt.text}</button>`;
            });
            html += `</div>`;
        }

        if (this.gameState.lastFeedback) {
            html += `<div class="feedback-box" style="display:block">${this.gameState.lastFeedback}</div>`;
            this.gameState.lastFeedback = null;
        }

        this.container.innerHTML = html;
    }

    renderSummary(isDead = false) {
        const rank = this.gameState.getRank();
        const finalScore = this.gameState.calculateFinalScore();

        let html = `<h1>${isDead ? "æ¨¡æ“¬å¤±æ•—" : "ç”Ÿå­˜å ±å‘Š"}</h1>`;
        html += `<div class="scene-image">${isDead ? "â˜ ï¸" : "ğŸ›¡ï¸"}</div>`;
        html += `
            <div class="description">
                <p>æœ€çµ‚è©•ç´šï¼š<strong style="font-size:1.5rem; color:var(--accent-color)">${rank}</strong></p>
                <p>ç”Ÿå‘½ç‹€æ…‹: ${this.gameState.hp}% | å¿ƒç†ç‹€æ…‹: ${this.gameState.sanity}%</p>
                <hr style="border-color:#444">
                <h3>ç‰©è³‡æª¢è¨ï¼š</h3>
                <p>${this.gameState.missingItems.length > 0 ? 
                   `<span style="color:var(--warning-color)">ä½ éºæ¼äº†é‡è¦ç‰©è³‡ï¼š${this.gameState.missingItems.join(', ')}</span>` : 
                   `<span style="color:var(--accent-color)">ä½ çš„é¿é›£åŒ…æº–å‚™å¾—éå¸¸å®Œç¾ï¼</span>`}
                </p>
                ${InventoryManager.hasWrongItems(this.gameState.supplies) ? 
                '<p style="color:#ff4444">æç¤ºï¼šé€ƒç”Ÿæ™‚è«‹å‹¿æ”œå¸¶éŠæˆ²æ©Ÿã€é…’é¡æˆ–éé‡çš„è²´é‡é‡‘å±¬ï¼Œé€™äº›æœƒæ¶ˆè€—ä½ çš„é«”åŠ›ã€‚</p>' : ''}
                
                <h3>è¡Œå‹•å›é¡§ï¼š</h3>
                <ul style="text-align:left; font-size:0.9rem; color:#aaa">
                    ${this.gameState.history.map(h => `<li><strong>${h.scene}</strong>: ${h.action} <br>â¥ ${h.feedback}</li>`).join('')}
                </ul>

                <div style="background:#333; padding:15px; margin-top:20px; border-radius:8px;">
                    <strong>ğŸ“¢ å°ç£æ°‘é˜²é‡é»æé†’ï¼š</strong>
                    <ul style="text-align:left; margin-top:10px;">
                        <li><strong>ç©ºè¥²è­¦å ±ï¼š</strong>è½è¾¨éŸ³ç¬¦ï¼ˆ15ç§’é•·éŸ³ã€5ç§’çŸ­éŸ³ï¼‰ï¼Œç«‹åˆ»å°‹æ‰¾åœ°ä¸‹å®¤æˆ–å …å›ºæ©é«”ï¼Œé é›¢çª—æˆ¶ã€‚</li>
                        <li><strong>åœ°éœ‡ï¼š</strong>è¶´ä¸‹(Drop)ã€æ©è­·(Cover)ã€ç©©ä½(Hold on)ã€‚</li>
                        <li><strong>é¿é›£åŒ…ï¼š</strong>æ°´ã€ä¹¾ç³§ã€è­‰ä»¶å½±æœ¬ã€ç¾é‡‘ã€æ€¥æ•‘è—¥å“ã€æ‰‹é›»ç­’ã€æ”¶éŸ³æ©Ÿã€ä¿æš–è¡£ç‰©ã€‚</li>
                        <li><strong>è³‡è¨Šä¾†æºï¼š</strong>ä¸‹è¼‰ã€Œæ¶ˆé˜²é˜²ç½eé»é€šã€APP æˆ–æ”¶è½å®˜æ–¹å»£æ’­ã€‚</li>
                    </ul>
                </div>
            </div>
            <button onclick="location.reload()" style="width:100%; margin-top:20px;">é‡æ–°é–‹å§‹æ¨¡æ“¬</button>
        `;
        this.container.innerHTML = html;
    }
}

// ============================================================================
// GAME CONTROLLER
// ============================================================================

class Game {
    constructor() {
        this.state = new GameState();
        this.container = document.getElementById('game-container');
        this.renderer = new Renderer(this.container, this.state);
        this.sceneManager = new SceneManager(this.state);
        this.currentScene = null;
    }

    start() {
        this.loadScene('intro');
    }

    loadScene(sceneId) {
        const scene = this.sceneManager.getScene(sceneId);
        if (!scene) return;

        this.state.currentScene = sceneId;
        this.currentScene = scene;

        // Handle special scene types
        if (scene.type === 'inventory') {
            this.renderer.renderInventorySelection();
            return;
        }

        if (scene.type === 'random') {
            const nextScene = this.sceneManager.selectRandomDisaster();
            this.loadScene(nextScene);
            return;
        }

        if (scene.type === 'summary') {
            this.renderer.renderSummary(this.state.isDead());
            return;
        }

        this.renderer.renderScene(scene);
    }

    confirmInventory() {
        const checkedBoxes = document.querySelectorAll('input[type="checkbox"]:checked');
        const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
        
        this.state.supplies = selectedIds;
        
        const evaluation = InventoryManager.evaluateSelection(selectedIds);
        this.state.score += evaluation.score;
        this.state.missingItems = evaluation.missingItems;

        this.loadScene('check_inventory');
    }

    makeChoice(optionIndex) {
        if (!this.currentScene || !this.currentScene.options) return;

        const option = this.currentScene.options[optionIndex];
        
        // Apply impact
        this.state.applyImpact(option.impact);

        // Check for death
        if (this.state.isDead()) {
            this.state.lastFeedback = "ä½ å—äº†è‡´å‘½å‚·ï¼Œç„¡æ³•ç¹¼çºŒè¡Œå‹•ã€‚";
            this.renderer.renderSummary(true);
            return;
        }

        // Store feedback and history
        if (option.feedback) {
            this.state.lastFeedback = option.feedback;
            this.state.addHistory(this.currentScene.title, option.text, option.feedback);
        }

        this.loadScene(option.next);
    }
}

// ============================================================================
// INITIALIZE GAME
// ============================================================================

const game = new Game();
game.start();
</script>

</body>
</html>
