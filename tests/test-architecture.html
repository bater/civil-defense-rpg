<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶æ§‹æ¸¬è©¦ - ç”Ÿå­˜æŒ‡å—</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            background: #2d2d2d;
        }
        .test-pass { color: #0f0; }
        .test-fail { color: #f00; }
        .test-pending { color: #ff0; }
        h2 { color: #4caf50; }
        pre { background: #1a1a1a; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ§ª æ¶æ§‹æ¸¬è©¦</h1>
    <div id="test-results"></div>

    <!-- Load all modules -->
    <script src="data/disaster-scenes.js"></script>
    <script src="js/models/GameState.js"></script>
    <script src="js/models/DataLoader.js"></script>
    <script src="js/logic/InventoryManager.js"></script>
    <script src="js/logic/SceneManager.js"></script>
    <script src="js/logic/EventManager.js"></script>
    <script src="js/views/GameRenderer.js"></script>
    <script src="js/controllers/GameController.js"></script>

    <script>
        const results = document.getElementById('test-results');

        function addTest(name, status, message = '') {
            const section = document.createElement('div');
            section.className = 'test-section';
            
            const statusClass = status === 'pass' ? 'test-pass' : 
                               status === 'fail' ? 'test-fail' : 'test-pending';
            
            const statusIcon = status === 'pass' ? 'âœ…' : 
                              status === 'fail' ? 'âŒ' : 'â³';
            
            section.innerHTML = `
                <h3 class="${statusClass}">${statusIcon} ${name}</h3>
                ${message ? `<pre>${message}</pre>` : ''}
            `;
            results.appendChild(section);
        }

        async function runTests() {
            addTest('é–‹å§‹æ¸¬è©¦', 'pending');

            // Test 1: Check if all classes are defined
            try {
                const classes = [
                    'GameState',
                    'DataLoader',
                    'InventoryManager',
                    'SceneManager',
                    'EventManager',
                    'GameRenderer',
                    'GameController'
                ];
                
                const missing = classes.filter(cls => typeof window[cls] === 'undefined');
                
                if (missing.length === 0) {
                    addTest('é¡åˆ¥å®šç¾©æª¢æŸ¥', 'pass', `æ‰€æœ‰ ${classes.length} å€‹é¡åˆ¥éƒ½å·²æ­£ç¢ºå®šç¾©`);
                } else {
                    addTest('é¡åˆ¥å®šç¾©æª¢æŸ¥', 'fail', `ç¼ºå°‘é¡åˆ¥: ${missing.join(', ')}`);
                }
            } catch (error) {
                addTest('é¡åˆ¥å®šç¾©æª¢æŸ¥', 'fail', error.message);
            }

            // Test 2: Check if disaster scenes data is loaded
            try {
                if (window.DISASTER_SCENES_DATA) {
                    const disasters = Object.keys(window.DISASTER_SCENES_DATA);
                    addTest('ç½é›£å ´æ™¯æ•¸æ“š', 'pass', `è¼‰å…¥äº† ${disasters.length} ç¨®ç½é›£: ${disasters.join(', ')}`);
                } else {
                    addTest('ç½é›£å ´æ™¯æ•¸æ“š', 'fail', 'æœªæ‰¾åˆ° DISASTER_SCENES_DATA');
                }
            } catch (error) {
                addTest('ç½é›£å ´æ™¯æ•¸æ“š', 'fail', error.message);
            }

            // Test 3: Initialize GameState
            try {
                const state = new GameState();
                if (state.hp === 100 && state.sanity === 100 && state.score === 0) {
                    addTest('GameState åˆå§‹åŒ–', 'pass', `HP: ${state.hp}, Sanity: ${state.sanity}, Score: ${state.score}`);
                } else {
                    addTest('GameState åˆå§‹åŒ–', 'fail', 'åˆå§‹å€¼ä¸æ­£ç¢º');
                }
            } catch (error) {
                addTest('GameState åˆå§‹åŒ–', 'fail', error.message);
            }

            // Test 4: Load data files
            try {
                const dataLoader = new DataLoader();
                const success = await dataLoader.loadAll();
                
                if (success) {
                    addTest('æ•¸æ“šæ–‡ä»¶è¼‰å…¥', 'pass', 
                        `Config: ${dataLoader.config ? 'âœ“' : 'âœ—'}\n` +
                        `Items: ${dataLoader.items ? dataLoader.items.length : 0} å€‹\n` +
                        `Events: ${dataLoader.itemEvents ? Object.keys(dataLoader.itemEvents).length : 0} å€‹\n` +
                        `Base Scenes: ${dataLoader.baseScenes ? Object.keys(dataLoader.baseScenes).length : 0} å€‹\n` +
                        `Disasters: ${dataLoader.disasters ? Object.keys(dataLoader.disasters).length : 0} å€‹`
                    );
                } else {
                    addTest('æ•¸æ“šæ–‡ä»¶è¼‰å…¥', 'fail', 'è¼‰å…¥å¤±æ•—');
                }

                // Test 5: Test InventoryManager
                if (success) {
                    const inventoryManager = new InventoryManager(dataLoader, dataLoader.config);
                    const weight = inventoryManager.calculateTotalWeight(['water', 'food']);
                    const expected = 5; // 3 + 2
                    
                    if (weight === expected) {
                        addTest('InventoryManager é‡é‡è¨ˆç®—', 'pass', `water + food = ${weight} kg`);
                    } else {
                        addTest('InventoryManager é‡é‡è¨ˆç®—', 'fail', `é æœŸ ${expected}ï¼Œå¾—åˆ° ${weight}`);
                    }

                    // Test overweight
                    const allItems = dataLoader.items.map(i => i.id);
                    const isOver = inventoryManager.isOverweight(allItems);
                    if (isOver) {
                        addTest('InventoryManager è¶…é‡æª¢æŸ¥', 'pass', 'æ­£ç¢ºæª¢æ¸¬åˆ°å…¨é¸æœƒè¶…é‡');
                    } else {
                        addTest('InventoryManager è¶…é‡æª¢æŸ¥', 'fail', 'æ‡‰è©²æª¢æ¸¬åˆ°è¶…é‡');
                    }
                }

                // Test 6: Test SceneManager
                if (success) {
                    const state = new GameState();
                    const sceneManager = new SceneManager(dataLoader, state);
                    
                    const introScene = sceneManager.getScene('intro');
                    if (introScene && introScene.type === 'inventory') {
                        addTest('SceneManager å ´æ™¯ç²å–', 'pass', `æˆåŠŸç²å– intro å ´æ™¯`);
                    } else {
                        addTest('SceneManager å ´æ™¯ç²å–', 'fail', 'ç„¡æ³•ç²å– intro å ´æ™¯');
                    }

                    // Test random disaster selection
                    const disasterScene = sceneManager.selectRandomDisaster();
                    if (disasterScene) {
                        addTest('SceneManager éš¨æ©Ÿç½é›£', 'pass', `é¸æ“‡äº†ç½é›£å ´æ™¯: ${disasterScene}`);
                    } else {
                        addTest('SceneManager éš¨æ©Ÿç½é›£', 'fail', 'ç„¡æ³•é¸æ“‡ç½é›£');
                    }
                }

                // Test 7: Test EventManager
                if (success) {
                    const eventManager = new EventManager(dataLoader, dataLoader.config);
                    const supplies = ['water', 'food', 'radio'];
                    const eventData = eventManager.selectRandomItemEvent(supplies);
                    
                    if (eventData) {
                        addTest('EventManager äº‹ä»¶é¸æ“‡', 'pass', 
                            `ç‰©å“: ${eventData.item.name}\n` +
                            `äº‹ä»¶: ${eventData.event.title}`
                        );
                    } else {
                        addTest('EventManager äº‹ä»¶é¸æ“‡', 'fail', 'ç„¡æ³•é¸æ“‡äº‹ä»¶');
                    }
                }

                // Test 8: Test GameController initialization
                try {
                    const controller = new GameController();
                    const initialized = await controller.initialize();
                    
                    if (initialized) {
                        addTest('GameController åˆå§‹åŒ–', 'pass', 'æ§åˆ¶å™¨æˆåŠŸåˆå§‹åŒ–');
                    } else {
                        addTest('GameController åˆå§‹åŒ–', 'fail', 'åˆå§‹åŒ–å¤±æ•—');
                    }
                } catch (error) {
                    addTest('GameController åˆå§‹åŒ–', 'fail', error.message);
                }

            } catch (error) {
                addTest('æ•¸æ“šæ–‡ä»¶è¼‰å…¥', 'fail', error.message);
            }

            // Final summary
            const allTests = document.querySelectorAll('.test-section');
            const passed = document.querySelectorAll('.test-pass').length;
            const failed = document.querySelectorAll('.test-fail').length;
            const total = allTests.length - 1; // Exclude "é–‹å§‹æ¸¬è©¦"

            addTest('æ¸¬è©¦ç¸½çµ', passed === total ? 'pass' : 'fail',
                `é€šé: ${passed}/${total}\n` +
                `å¤±æ•—: ${failed}/${total}\n` +
                `æˆåŠŸç‡: ${Math.round((passed/total)*100)}%`
            );
        }

        // Run tests when page loads
        runTests();
    </script>
</body>
</html>
